{% extends 'base.html' %}

{% block title %}
    Drink Builder
{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type='text/javascript'>
const cocktail = {{ cocktail|safe }}
</script>
<!------------------------------- HTML --------------------------------->
<div class='container' id='drink-edit'>
    <div class='top-bar'>
        <p class='logo'>Logo</p>
        <h2 class='cocktail-name'>[[cocktail.name]]</h2>
        <a href='#'><p class='add-ingredient-button'> ADD INGREDIENT</p></a>
    </div>
    <div class='cost-bar default-shadow'>
      <p class='target-cost'>Adjust Percentage of Menu Price:</p>
      <div class="input-contain">
        <input id="target-percent" class="input-default" v-model="targetMargin" type="number" min="1" max="100"><label for="target-percent">%</label>
      </div>
    </div>
    <div class='cost-sell-box default-shadow'>
        <div class='total-cost-box'>
            <p>Cost of Goods</p>
            <p>$ [[ displayCost ]]</p>
        </div>
        <div class='menu-price-box'>
            <p>Menu Price</p>
            <p>$[[ menuPrice ]]</p>
        </div>
    </div>

    <div v-for="shot in filterDeletedShots" class="menu-item default-shadow">
      <shot-line v-bind:shot="shot" v-bind:id="shot.id" ></shot-line>
    </div>

    <button class='btn green-bg default-shadow vert-margin-10 text-dark' type="button">SAVE</button>
</div>

<script>
// --------------------------------------AJAX CONFIG-------------------------------------
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const instance = axios.create({
  headers: {
    'X-CSRFToken': getCookie("csrftoken"),
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  }
})

// ----------------------------------VUE COMPONENTS---------------------------------------

const ShotLine = {
  delimiters: ['[[', ']]'],
  props: {
    shot: Object,
  },
  data: function(){
    return {
      volume: "",
      pourCost: "",
    }
  },
  template:`
  <div v-bind:id="shot.id" class="wide-100 flex">
    <div class="wide-100 flex">
      <div class="menu-input center-txt">
        <i @click="subtractVolume" class="fas fa-angle-double-left" title="decrease pour volume by 0.25 oz"></i>
        <p class="light-stroke">LESS</p>
      </div>
      <div class="menu-mid">
        <p class='bold wide-100 center-txt'>[[ shot.brandname ]]</p>
        <div class='wide-100 center-txt'>
        <input class="input-default" type="number" min="0" v-model="volume" placeholder="custom"/><label>oz</lable>
        </div>
        <p class="wide-100 center-txt">Cost of pour: $ <span class="ingredient-cost">[[ adjustedCost ]]</span></p>
        <button v-on:click="addToDeleted(shot.id)" v-on:click="deleteShot(shot.id)" v-on:click="deleteShotValues()" class="btn center-butt default-shadow">DELETE</button>
      </div>
      <div class="menu-input center-txt">
        <i @click="addVolume" class="fas fa-angle-double-right" title="increase pour volume by 0.25 oz"></i>
        <p class="light-stroke">MORE</p>
      </div>
    </div>

  </div>`,
  methods: {
    deleteShot: function(id) {
        instance.delete(`http://127.0.0.1:8000/api/shot/${id}`)
        .then(function(response) {
          // let costToSubtract = (parseFloat(this.cost) * parseFloat(this.volume).toFixed(2))
          // console.log(costToSubtract)
          // this.$parent.totalPrice -= costToSubtract
      }).then(function(id){
          
      }).catch(function(ex) {
        console.log('parsing failed', ex)
      })

      console.log(`DELETE Shot ${id}`)
    },
    addVolume: function(){
      this.volume+=0.25
    },
    subtractVolume: function(){
      this.volume-=0.25
    },
    addToDeleted: function(id) {
      this.$parent.deletedShots.push(id)
    },
    deleteShotValues: function() {
      let costToSubtract = (parseFloat(this.shot.cost) * parseFloat(this.volume).toFixed(2))
          console.log(costToSubtract)
          this.$parent.totalPrice -= costToSubtract
    }
    
  },

  computed: {
    adjustedCost: function(){
      let total = (parseFloat(this.shot.cost) * parseFloat(this.volume)).toFixed(2)
      return total
    }
  },
  watch: {
    volume: function(newVolume, oldVolume){
      newCost = newVolume * this.shot.cost
      oldCost = oldVolume * this.shot.cost

      this.$parent.totalPrice += newCost
      this.$parent.totalPrice -= oldCost
    }
  },
  mounted(){
    this.volume = this.shot.volume
  }
}

// -----------------------------------VUE APP INSTANCE---------------------------
let app = new Vue({
  delimiters: ['[[', ']]'],
  el: '#drink-edit',
  components: {
    'shot-line': ShotLine,
    // "portion-line": PortionLine,
  },
  data: {
    cocktail: cocktail,
    targetMargin: cocktail.target,
    totalPrice: 0,
    newShots: [],
    newPortions: [],
    deletedShots: [],
    showModal: -1,
    allPourCosts: function(){
      return document.querySelectorAll('.pour-cost')
    },
    modal_info:{
      id:"",
      name: "",
      target:"",
      shots: {
        id:"",
        volume:"",
        cost:"",
        brandname:""
      },
      portions: {
        id:"",
        amount:"",
        cost:"",
        name:""
      }
    }
  },
  methods: {
    saveCocktail: function(id) {
        instance.post(`http://127.0.0.1:8000/api/cocktail/${id}`)
    },
    cocktailSummary: function(id) {
      this.showModal = id
      for(let cocktail of this.cocktails){
        if(cocktail.id == id) {
          this.modal_info = cocktail
          this.modal_shots = cocktail.shots
          this.modal_portions = cocktail.portions
        }
      }
    },
  },
  computed:{
    displayCost: function(){
      return parseFloat(this.totalPrice).toFixed(2)
    },
    menuPrice: function(){
      return parseFloat(this.totalPrice / (this.targetMargin/100)).toFixed(2)
      // parseFloat(this.totalPrice * (this.targetMargin/100) + this.totalPrice).toFixed(2)
    },
    filterDeletedShots: function(){
      return this.cocktail.shots.filter((shot)=>{
        return !this.deletedShots.includes(shot.id)

      })
    }
  },
})

// <input v-model="volume" v-on:change="adjustPourCost" v-on:change="$emit('change')" type="range" min=".25" max="6" step=".25" class="slider"/>
</script>

{% endblock %}