{% extends 'base.html' %}

{% block title %}
Drink Builder
{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/node-uuid/1.4.8/uuid.min.js"></script>
<script type='text/javascript'>
  const cocktail = {{ cocktail| safe }}
  const spirits = {{ spirits| safe }}

</script>
<!------------------------------- HTML --------------------------------->
<div class='container' id='drink-edit'>
  <div class='top-bar'>
    <p class='logo'>Logo</p>
    <h2 class='cocktail-name'>[[cocktail.name]]</h2>
    <div id="drink-edit">
<!---------------------------MODAL CODE--------------------------------------->
      <button @click='modalAction()' class='btn' type=button> ADD INGREDIENT</button>
      <div v-if="modal" class=modal-bg>
        <div class="modal-container modal-lg just-cent align-base">
          <select class="wide-70 input-default white-bg" v-model="toAdd">
            <option value="shot">Pick from Database</option>
            <option value="portion">Custom</option>
          </select>
          <button @click='modalAction()' type="button" class="btn wide-20"> Close</button>
          <!-- Shot logic -->
          <div v-if="toAdd=='shot'">
            <select class="wide-100 input-default white-bg" v-model="categorySelection">
              <option value="All" selected>All Categories</option>
              <option value="Brandy & Cognac">Brandy & Cognac</option>
              <option value="Bourbon">Bourbon</option>
              <option value="Canadian Whiskey">Canadian Whiskey</option>
              <option value="Cordials & Liqueurs">Cordials & Liqueurs</option>
              <option value="Gin">Gin</option>
              <option value="Irish Whiskey">Irish Whiskey</option>
              <option value="NC Products">NC Products</option>
              <option value="Other">Other</option>
              <option value="Rum">Rum</option>
              <option value="Rye">Rye</option>
              <option value="Scotch">Scotch</option>
              <option value="Tequila & Mezcal">Tequila & Mezcal</option>
              <option value="Vodka">Vodka</option>
              <option value="Whiskey - Other">Whiskey - Other</option>
            </select>
            <input v-model="spiritSearch" type="text" placeholder="filter by name" class="input-default wide-100 white-bg"/>
            <select class="input-default wide-100 text-left pad-5 white-bg" v-model="newSpirit" id="" size="12" required>
              <option class="vert-margin-3" v-for="spirit in filteredSpirits" v-bind:value="spirit.id"class="wide-100 white-bg">[[ spirit.brandname ]]: $ [[ spirit.cost ]] per oz </option>
            </select>
            <button @click='createNewShot' type="button" class="btn green-bg">Add</button>
          </div>
          <!-- Portion logic  -->
          <div v-if="toAdd=='portion'">
            <input class="wide-100 input-default white-bg"id="portion-ingredient" v-model="newPortion.ingredient" type="text" placeholder="Name of ingredient"/>
            <label class="wide-30" for="portion-unit-cost">Price per unit: $</label><input class="wide-70 input-default white-bg" id="portion-unit-cost" v-model="newPortion.costPerUnit" type="number"/>
            <input class="wide-100 input-default white-bg"v-model="newPortion.unit" type="text" placeholder="unit" title="ounces, grams, ml, etc."/>
            <label class="wide-30" for="portion-starting-amt">Amount:</label><input class="wide-70 input-default white-bg" id="portion-starting-amt" v-model="newPortion.startingAmount" type="number"/>
            <button @click="createNewPortion"class="btn green-bg">SUBMIT</button>
          </div>
        </div>
      </div>
<!--------------------------END MODAL CODE--------------------------------------->
    </div>
  </div>
  <div class='cost-bar default-shadow'>
    <p class='target-cost'>Adjust Percentage of Menu Price:</p>
    <div class="input-contain">
      <input id="target-percent" class="input-default" v-model="targetMargin" type="number" min="1" max="100"><label
        for="target-percent">%</label>
    </div>
  </div>
  <div class='cost-sell-box default-shadow'>
    <div class='total-cost-box'>
      <p>Cost of Goods</p>
      <p>$ [[ displayCost ]]</p>
    </div>
    <div class='menu-price-box'>
      <p>Menu Price</p>
      <p>$[[ menuPrice ]]</p>
    </div>
  </div>

  <div v-for="shot in filterDeletedShots" v-bind:key="shot.id" class="menu-item default-shadow">
    <shot-line v-bind:shot="shot" v-on:changevol="updateShotVolumes" ref="shotSet"></shot-line>
  </div>
  <div v-if="newShots.length > 0">
    <div v-for="shot in filterDeletedNewShots" v-bind:key="shot.id" class="menu-item default-shadow">
      <shot-line v-bind:shot="shot" v-on:changevol="updateShotVolumes" ref="shotSet"></shot-line>
    </div>
  </div>
  <div v-for="portion in filterDeletedPortions" class="menu-item default-shadow">
    <portion-line v-bind:portion="portion" v-on:changeamt="updatePortionAmounts" ref="portionSet"></portion-line>
  </div>
  <div v-for="portion in filterDeletedNewPortions"  class="menu-item default-shadow">
    <portion-line v-bind:portion="portion" v-on:changeamt="updatePortionAmounts" ref="portionSet"></portion-line>
  </div>

  <button @click="submitPage"class='btn green-bg default-shadow vert-margin-10 text-dark' type="button">SAVE</button>
</div>

<script>
  // --------------------------------------AJAX CONFIG-------------------------------------

  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const instance = axios.create({
    headers: {
      'X-CSRFToken': getCookie("csrftoken"),
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    }
  })

  // ----------------------------------VUE COMPONENTS---------------------------------------

const ShotLine = {
  delimiters: ['[[', ']]'],
  props: {
    shot: Object,
  },
  data: function () {
    return {
      volume: "",
      pourCost: "",
    }
  },
  template: `
  <div class="wide-100 flex">
    <div class="wide-100 flex">
      <div class="menu-input center-txt">
        <i @click="subtractVolume" @click="$emit('changevol',shot.id, volume)" class="fas fa-angle-double-left" title="decrease pour volume by 0.25 oz"></i>
        <p class="light-stroke">LESS</p>
      </div>
      <div class="menu-mid">
        <p class='bold wide-100 center-txt'>[[ shot.brandname ]]</p>
        <div class='wide-100 center-txt'>
        <input class="input-default" type="number" min="0" v-model="volume" placeholder="custom"/><label>oz</lable>
        </div>
        <p class="wide-100 center-txt">Cost of pour: $ <span class="ingredient-cost">[[ adjustedCost ]]</span></p>
        <button v-on:click="addToDeleted(shot.id)" v-on:click="deleteShot(shot.id)" v-on:click="deleteShotValues()" class="btn center-butt default-shadow">DELETE</button>
      </div>
      <div class="menu-input center-txt">
        <i @click="addVolume" @click="$emit('changevol',shot.id, volume)" class="fas fa-angle-double-right" title="increase pour volume by 0.25 oz"></i>
        <p class="light-stroke">MORE</p>
      </div>
    </div>

  </div>`,
  methods: {
    deleteShot: function (id) {
      instance.delete(`/api/shot/${id}`)
        .then(function (response) {
        }).then(function (id) {
        }).catch(function (ex) {
          console.log('parsing failed', ex)
        })

      console.log(`DELETE Shot ${id}`)
      // location.reload()
    },
    addVolume: function () {
      this.volume += 0.25
    },
    subtractVolume: function () {
      this.volume -= 0.25
    },
    addToDeleted: function (id) {
      this.$parent.deletedShots.push(id)
    },
    deleteShotValues: function () {
      let costToSubtract = (parseFloat(this.shot.cost) * parseFloat(this.volume).toFixed(2))
      console.log(costToSubtract)
      this.$parent.totalPrice -= costToSubtract
    }

  },

  computed: {
    adjustedCost: function () {
      let total = (parseFloat(this.shot.cost) * parseFloat(this.volume)).toFixed(2)
      return total
    },
  },
  watch: {
    volume: function (newVolume, oldVolume) {
      newCost = newVolume * this.shot.cost
      oldCost = oldVolume * this.shot.cost

      this.$parent.totalPrice += newCost
      this.$parent.totalPrice -= oldCost
    },
    submitStatus: function(newStatus, oldStatus) {
      console.log("submit detected")
      if (newStatus==true) {
        instance.patch(`/shot/${this.shot.id}/`,{
          volume: this.volume
        })
        .then(res => console.log(res))
        .catch(res => console.log(res))
      }
    }
  },
  mounted() {
    this.volume = this.shot.volume
    this.submit = false
  }
}
// ------------------------PORTION COMPONENT--------------------------------

const PortionLine = {
  delimiters: ['[[', ']]'],
  props: {
    portion: Object,
    submitStatus: Boolean,
  },
  data: function () {
    return {
      amount: "",
      amountCost: "",
    }
  },
  template: `
  <div class="wide-100 flex">
    <div class="wide-100 flex">
      <div class="menu-input center-txt">
        <i @click="subtractAmount" class="fas fa-angle-double-left" title="decrease amount by 0.25 oz"></i>
        <p class="light-stroke">LESS</p>
      </div>
      <div class="menu-mid">
        <p class='bold wide-100 center-txt'>[[ portion.name ]]</p>
        <div class='wide-100 center-txt'>
        <input class="input-default" type="number" min="0" v-model="amount" placeholder="custom"/><label>[[ portion.unit ]]</lable>
        </div>
        <p class="wide-100 center-txt">Ingredient Cost: $ <span class="ingredient-cost">[[ adjustedCost ]]</span></p>
        <button v-on:click="addToDeleted(portion.id)" v-on:click="deletePortion(portion.id)" v-on:click="deletePortionValues()" class="btn center-butt default-shadow">DELETE</button>
      </div>
      <div class="menu-input center-txt">
        <i @click="addAmount" class="fas fa-angle-double-right" title="increase pour volume by 0.25 oz"></i>
        <p class="light-stroke">MORE</p>
      </div>
    </div>

  </div>`,
  methods: {
    deletePortion: function (id) {
      instance.delete(`/api/portion/${id}`)
        .then(function (response) {
        }).then(function (id) {
        }).catch(function (ex) {
          console.log('parsing failed', ex)
        })

      console.log(`DELETE Portion ${id}`)
    },
    addAmount: function () {
      this.amount += 0.25
    },
    subtractAmount: function () {
      this.amount -= 0.25
    },
    addToDeleted: function (id) {
      this.$parent.deletedPortions.push(id)
    },
    deletePortionValues: function () {
      let costToSubtract = (parseFloat(this.portion.cost) * parseFloat(this.amount).toFixed(2))
      console.log(costToSubtract)
      this.$parent.totalPrice -= costToSubtract
    }

  },

  computed: {
    adjustedCost: function () {
      let total = (parseFloat(this.portion.cost) * parseFloat(this.amount)).toFixed(2)
      return total
    },
  },
  watch: {
    amount: function (newAmount, oldAmount) {
      newCost = newAmount * this.portion.cost
      oldCost = oldAmount * this.portion.cost

      this.$parent.totalPrice += newCost
      this.$parent.totalPrice -= oldCost
    },
    'submitStatus': function(newStatus, oldStatus) {
      console.log("submit detected")
      if (newStatus === true) {
        instance.patch(`/portion/${this.portion.id}/`,{
          amount: this.amount
        })
        .then(res => console.log(res))
        .catch(res => console.log(res))
      }
    }

  },
  mounted() {
    this.amount = this.portion.amount
  }
}

// -----------------------------------VUE APP INSTANCE---------------------------
let app = new Vue({
  delimiters: ['[[', ']]'],
  el: '#drink-edit',
  components: {
    'shot-line': ShotLine,
    "portion-line": PortionLine,
  },
  data: {
    cocktail: cocktail,
    spirits: spirits,
    targetMargin: cocktail.target,
    totalPrice: 0,
    updatedShotVolumes:[
      {id:"", volume:""}
    ],
    updatedPortionAmounts: [
      {id:"", amount:""}
    ],
    newShots: [],
    newPortions: [],
    deletedShots: [],
    deletedPortions: [],
    categorySelection:"All",
    toAdd:"shot",
    newSpirit:"",
    newPortion: {
      ingredient:"",
      costPerUnit:0,
      unit:"",
      startingAmount: 0,
      ingredientID:"",
    },
    spiritSearch:"",
    showModal: -1,
    modal:false,
    modal_info: {
      id: "",
      name: "",
      target: "",
      shots: {
        id: "",
        volume: "",
        cost: "",
        brandname: ""
      },
      portions: {
        id: "",
        amount: "",
        cost: "",
        name: ""
      }
    }
  },
  methods: {
    modalAction() {
      if (this.modal == false) {
        this.modal = true
      } else {
        this.modal = false
      }
    },
    saveCocktail: function (id) {
      console.log("naw dude. wrong function")
    },
    createNewShot: function(){
      let spiritInfo;
      for (let spirit of this.spirits){
        if(parseInt(spirit.id) == this.newSpirit){
          spiritInfo = spirit
        }
      }
      console.log(spiritInfo)

      instance.post('/api/shot/', {
        volume: .25,
        spirit: spiritInfo.id,
        cocktail: this.cocktail.id
      })
      .then(res => {
        this.newShots.push({
        id: res.data.id,
        volume: res.data.volume,
        cost: spiritInfo.cost,
        brandname: spiritInfo.brandname
      })
      })
      .catch(res => console.log(res))
      this.newSpirit = ""
      this.modal = false
    },
    createNewPortion: function(){
      instance.post('/api/misc/',{
        name: this.newPortion.ingredient,
        cost_per_unit: this.newPortion.costPerUnit,
      })
      .then(res => {
        instance.post('/api/portion/', {
          amount: this.newPortion.startingAmount,
          unit: this.newPortion.unit,
          price_per_unit: res.data.cost_per_unit,
          cocktail: this.cocktail.id,
          misc_ingredient: res.data.id,
        })
        .then(res => {
          this.newPortions.push({
            id: res.data.id,
            amount: res.data.amount,
            unit: res.data.unit,
            cost: res.data.price_per_unit,
            name: this.newPortion.ingredient,
          })
        .catch(res =>
        console.log("your portion response:"),
        console.log(res))
      })
      .catch(res =>
        console.log("your misc ingredient response:"),
        console.log(res))

      this.newPortion = {
        ingredient:"",
        costPerUnit:0,
        unit:"",
        startingAmount: 0,
      }
      this.modal = false
      })
    },
    submitPage: function() {
      allShots = this.$refs.shotSet
      allPortions = this.$refs.portionSet

      if (allShots !== undefined){
        for(let i=0; i<allShots.length; i++){
          instance.patch(`/api/shot/${allShots[i].shot.id}/`, {volume: allShots[i].volume})
          .then(res => {console.log(res)})
          .catch(res => {console.log(res)})
        }}

      if (allPortions !== undefined){
        for(let i=0; i<allPortions.length; i++){
          instance.patch(`/api/portion/${allPortions[i].portion.id}/`, {amount: allPortions[i].amount})
          .then(res => {console.log(res)})
          .catch(res => {console.log(res)})
        }}
    },
    updateShotVolumes: function(id, volume){
      let volumes = this.updatedShotVolumes
      for (let i=0; i< volumes.length; i++){
        if(volumes[i].id === id){
          console.log("ID found"),
          volumes[i].volume = volume
        }
      }
    },
    updatePortionAmounts: function(obj){
      console.log("not hooked up yet")
    }
  },
  computed: {
    displayCost: function () {
      return parseFloat(this.totalPrice).toFixed(2)
    },
    menuPrice: function () {
      return parseFloat(this.totalPrice / (this.targetMargin / 100)).toFixed(2)
    },
    filterDeletedShots: function () {
      let filter = this.cocktail.shots.filter((shot) => {
        return !this.deletedShots.includes(shot.id)
      })
      return filter
    },
    filterDeletedNewShots: function (){
      let filter = this.newShots.filter((shot)=> {
        return !this.deletedShots.includes(shot.id)
      })
      return filter
    },
    filterDeletedPortions: function () {
      let filter = this.cocktail.portions.filter((portion) => {
        return !this.deletedPortions.includes(portion.id)
      })
      return filter
    },
    filterDeletedNewPortions: function(){
      let filter = this.newPortions.filter((portion)=> {
        return !this.deletedPortions.includes(portion.id)
      })
      return filter
    },
    filteredSpirits: function(){
      let brandnameFilter = this.spirits
      if (this.categorySelection !== "All") {
        brandnameFilter = this.spirits.filter((spirit)=>{
          return spirit.category.toUpperCase().match(this.categorySelection.toUpperCase())
        })
      }
      searchFilter = brandnameFilter.filter((spirit)=>{
        return spirit.brandname.toUpperCase().match(this.spiritSearch.toUpperCase())
      })
      return searchFilter
    }
  },
  mounted(){
    this.newShots = []
    this.newPortions = []
  }
})

</script>
{% endblock %}