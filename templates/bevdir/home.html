{% extends 'base.html' %}
{% block title %}
BevDev Home
{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
<script type='text/javascript'>
  const cocktails = {{ cocktails| safe }}
  console.log(cocktails)
</script>
<!---------------------------------BEGIN HTML --------------------------->

<!---------------------------BEGIN MAIN---------------->
{% if user.is_authenticated %}
<div id='homeapp' class="container wide-100 flex-wrap">
  <header class='header container wide-100 space-between align-center'>
    <!-- <p class='wide-20 logo height-100'>Logo</p> -->
    <a class="wide-60 flex-col height-100" href="/">
      <p class='site-title text-left'>BevDev</p>
    </a>
    <div class='header-links text-white align-center flex-end wide-20 flex height-100 text-right'>
      {% if user.is_authenticated %}
      <p class="">{{ user }} | <a href="/accounts/logout/"> Logout </a></p>
      {% else %}
      <a href="/accounts/register/"> Register </a>
      |
      <a href="/accounts/login/"> Log in </a>
      {% endif %}
    </div>
  </header>
  <nav class="wide-100 dark-bg flex space-between pad-5">
    <input type="text" v-model="search" placeholder="search"
      class="wide-70 input-default dark-bg text-white lt-placeholder" />
    <button class="btn wide-30" @click="createModalAction">New Cocktail</button>
  </nav>
  <!------------------------MENU ITEMS---------------------->
  <!------NEW COCKTAIL MODAL------->
  <div class="wide-50 min-400">
    <div v-if="showCreateModal" class="modal-bg">
      <div class="wide-40 min-400 center-auto round-corners pad-10 blue-bg flex default-shadow">
        <form class="wide-100 flex flex-wrap flex-start align-center">
          <p class="wide-100 bold">Create a Cocktail</p>
          <div class="vert-padding-3 wide-100">
            <label for="new-cocktail-name" class="label-default">Name:</label>
            <input class="input-default" v-model="newCocktail.name" id="new-cocktail-name" placeholder="cocktial name">
          </div>
          <div class="vert-padding-3 wide-100">
            <label class="label-default" for="new-cocktail-target">Target Pour Cost:</label>
            <input class="input-default" v-model="newCocktail.target" type="new-cocktail-target" type="number" min="1"
              max="100" placeholder="target percent of menu price">
          </div>
          <button @click="submitNewCocktail" class="btn-alt">Submit</button>
          <button @click="createModalAction" class="btn">Exit</button>
        </form>
      </div>
    </div>
    <p class="text-center bold txt-1h vert-padding-3">Your Drink Menu</p>

    <div v-for="cocktail in filteredCocktails">
      <div v-bind:id="cocktail.id" @click="modalAction(cocktail.id)"
        class="menu-item hover-blue-dark wide-100 flex-wrap default-shadow">
        <div class="wide-100 flex">
          <p class="bold">[[ cocktail.name ]]</p>
        </div>
        <!-- hidden items  -->
        <div v-if="showModal==cocktail.id">
          <p>Liquors</p>
          <ul class='ingredient-ul'>
            <li v-for="shot in cocktail.shots">[[shot.volume]] oz of [[shot.brandname]]</li>
          </ul>
          <p>Mixers</p>
          <ul class='ingredient-ul'>
            <li v-for="portion in cocktail.portions">
              [[ portion.amount ]] [[portion.unit]] of [[ portion.name ]]</li>
          </ul>
          <a v-bind:href="`/cocktails/${cocktail.id}`"><button class="btn menu-butt">EDIT</button></a>
          <button @click="showDeleteModal=(cocktail.id)" class="btn menu-butt">DELETE</button>
          <!-- <button @click="showModal=-1" class="btn">CLOSE</button> -->
        </div>
      </div>
      <!-- DELETE CONFIRMATION MODAL -->
      <div v-if="showDeleteModal==cocktail.id" class="modal-bg">
        <div class="modal-container pnk-bg">
          <p class="bold">Are you sure you want to delete [[ cocktail.name ]]?</p>
          <button @click="deleteCocktail(cocktail.id)" class="btn danger-butt">YES, PLEASE DELETE.</button>
          <button @click="showDeleteModal=-1" class="btn menu-butt">NO! PEASE DON'T!</button>
        </div>
      </div>
    </div>
  </div>
  <div class="wide-50">
    <menu-graph></menu-graph>
  </div>
</div>
  <!---------------------------MENU STATS/FIGURE?--------------------->
  <footer></footer>
  {% endif %}
  <!----------------------END HTML/START AXIOS CONFIG ------------------------->
  <script>

    let menuGraph = {
      delimiters: ['[[', ']]'],
      props: {

      },
      data: function () {
        return {

        }
      },
      template: `
        <div class="wide-100">
          <canvas id="my-menu-stats" width="400" height="400"></canvas>
        </div>
      `
      ,
      mounted() {
        let canvas = document.getElementById('my-menu-stats').getContext('2d')

        let menuStatsChart = new Chart(canvas, {
          type: 'horizontalBar',
          data: {
            labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
            datasets: [{
              label: '# of Votes',
              data: [12, 19, 3, 5, 2, 3],
              backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)'
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: false,
            scales: {
              yAxes: [{
                ticks: {
                  beginAtZero: true
                }
              }]
            }
          }
        })
      }
    }



    // --------------------AXIOS CONFIG --------------------------
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const instance = axios.create({
      headers: {
        'X-CSRFToken': getCookie("csrftoken"),
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    })

    //  ----------------------------------VUE INSTANCE-----------------------------
    let app = new Vue({
      delimiters: ['[[', ']]'],
      el: '#homeapp',
      components: {
        'menu-graph': menuGraph
      },
      data: {
        cocktails: [],
        deletedCocktails: [],
        showModal: -1,
        showDeleteModal: -1,
        showCreateModal: false,
        search: "",
        modal_info: {
          id: "",
          name: "",
          target: "",
          shots: {
            id: "",
            volume: "",
            cost: "",
            brandname: ""
          },
          portions: {
            id: "",
            amount: "",
            cost: "",
            name: ""
          }
        },
        newCocktail: {
          name: "",
          target: 0,
        }
      },
      methods: {
        deleteCocktail: function (id) {
          this.deletedCocktails.push(id)
          instance.delete(`http://127.0.0.1:8000/api/cocktail/${id}`)
            .then(function (response) {
            }).then(function (data) {
              console.log("data is ok", data)
            }).catch(function (ex) {
              console.log('parsing failed', ex)
            })

          console.log(`Haha, youre trying to delete cocktail ${id} but I didnt listen`)
        },
        modalAction: function (id) {
          if (this.showModal === id) {
            this.showModal = -1
          }
          else {
            this.showModal = id
          }
        },
        createModalAction: function () {
          if (this.showCreateModal) {
            this.showCreateModal = false
          }
          else {
            this.showCreateModal = true
          }
        },
        submitNewCocktail: function () {
          instance.post('/api/cocktail/', {
            name: this.newCocktail.name,
            target_profit: this.newCocktail.target,
          })
            .then(res => {
              window.location = `/cocktails/${res.data.id}/`
            })
            .catch(res => {
              console.log(res)
            })
        }
      },
      computed: {
        filteredCocktails: function () {
          let filter_deleted = cocktails.filter((cocktail) => {
            return !this.deletedCocktails.includes(cocktail.id) && cocktail.name.toUpperCase().match(this.search.toUpperCase())
          })
          return filter_deleted
        }
      }
    })
  </script>

  {% endblock %}